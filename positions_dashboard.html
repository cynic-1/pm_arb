<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Polymarket & Opinion 仓位看板</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --border: #334155;
      --loss: #f87171;
      --gain: #4ade80;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 2rem 1rem 3rem;
    }

    main {
      width: min(1200px, 100%);
    }

    h1 {
      margin: 0 0 0.5rem;
      font-size: clamp(1.8rem, 3vw, 2.3rem);
    }

    .subtitle {
      margin: 0 0 1.5rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 1.2rem;
    }

    section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.4rem;
      box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.45);
      overflow: hidden;
    }

    .table-wrapper {
      overflow-x: auto;
      margin: 0 -0.5rem;
      padding: 0 0.5rem;
    }

    section header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .tag {
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(56, 189, 248, 0.16);
      color: var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      table-layout: fixed;
    }

    table.trades-table {
      table-layout: auto;
      min-width: 100%;
    }

    table.trades-table td,
    table.trades-table th {
      white-space: nowrap;
      padding: 0.4rem 0.5rem;
    }

    table.trades-table td:nth-child(2) {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th,
    td {
      text-align: left;
      padding: 0.45rem 0.35rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    th {
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--muted);
    }

    tbody tr:hover {
      background: rgba(148, 163, 184, 0.05);
    }

    .value-large {
      font-size: 1.7rem;
      font-weight: 600;
      color: var(--accent);
    }

    .meta {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .pill {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .error {
      color: var(--loss);
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      font-size: 0.72rem;
      background: rgba(148, 163, 184, 0.15);
    }

    .gain {
      color: var(--gain);
    }

    .loss {
      color: var(--loss);
    }

    .empty {
      text-align: center;
      padding: 1rem 0;
      color: var(--muted);
    }

    .more-btn {
      padding: 0.35rem 0.8rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--accent);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }

    .more-btn:hover {
      background: rgba(56, 189, 248, 0.1);
      border-color: var(--accent);
    }

    .trade-side-buy {
      color: var(--gain);
      font-weight: 500;
    }

    .trade-side-sell {
      color: var(--loss);
      font-weight: 500;
    }

    .trade-type {
      font-size: 0.75rem;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      background: rgba(148, 163, 184, 0.15);
    }
  </style>
</head>
<body>
  <main>
    <h1>Polymarket & Opinion 仓位看板</h1>
    <p class="subtitle">
      数据每 10 分钟自动刷新一次，无需手动操作。
      <span id="last-updated" class="badge">等待加载...</span>
    </p>
    <div style="margin-bottom: 1rem; display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center;">
      <span class="meta">下一次自动刷新倒计时：<span id="countdown">--:--:--</span></span>
    </div>

    <div class="sections">
      <!-- Recent Trades Section -->
      <section id="poly-trades-section">
        <header>
          <div>
            <h2 style="margin: 0">Polymarket 最近交易</h2>
            <p class="pill">最近成交记录</p>
          </div>
          <button class="more-btn" id="poly-trades-more-btn" onclick="togglePolyTrades()">展开更多</button>
        </header>
        <div class="table-wrapper">
          <table id="poly-trades-table" class="trades-table">
            <thead>
              <tr>
                <th>时间</th>
                <th>市场</th>
                <th>方向</th>
                <th>份额</th>
                <th>价格</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="meta" id="poly-trades-empty" style="display: none; text-align: center;">暂无交易记录</p>
      </section>

      <section id="opinion-trades-section">
        <header>
          <div>
            <h2 style="margin: 0">Opinion 最近交易</h2>
            <p class="pill">最近成交记录</p>
          </div>
          <button class="more-btn" id="opinion-trades-more-btn" onclick="toggleOpinionTrades()">展开更多</button>
        </header>
        <div class="table-wrapper">
          <table id="opinion-trades-table" class="trades-table">
            <thead>
              <tr>
                <th>时间</th>
                <th>市场</th>
                <th>方向</th>
                <th>份额</th>
                <th>价格</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="meta" id="opinion-trades-empty" style="display: none; text-align: center;">暂无交易记录</p>
      </section>

      <section id="matched-pairs-section" style="grid-column: 1 / -1;">
        <header>
          <div>
            <h2 style="margin: 0">跨平台配对仓位</h2>
            <p class="pill">完全匹配的对冲仓位</p>
          </div>
          <span class="tag">结算价值</span>
        </header>
        <div class="value-large" id="matched-total">$0.00</div>
        <p class="meta" id="matched-error"></p>
        <table id="matched-pairs-table">
          <thead>
            <tr>
              <th>市场</th>
              <th>类型</th>
              <th>Poly份额</th>
              <th>Opinion份额</th>
              <th>匹配份额</th>
              <th>结算价值</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="polymarket-section">
        <header>
          <div>
            <h2 style="margin: 0">Polymarket</h2>
            <p class="pill">地址：<span id="poly-address">--</span></p>
          </div>
          <span class="tag">总价值</span>
        </header>
        <div class="value-large" id="poly-total">$0.00</div>
        <p class="meta" id="poly-error"></p>
        <table id="polymarket-table">
          <thead>
            <tr>
              <th>市场</th>
              <th>方向</th>
              <th>份额</th>
              <th>均价</th>
              <th>市值</th>
              <th>PnL</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="opinion-section">
        <header>
          <div>
            <h2 style="margin: 0">Opinion</h2>
            <p class="pill">API Key：<span id="opinion-status">检测中</span></p>
          </div>
          <span class="tag">总价值</span>
        </header>
        <div class="value-large" id="opinion-total">$0.00</div>
        <p class="meta" id="opinion-error"></p>
        <table id="opinion-table">
          <thead>
            <tr>
              <th>市场</th>
              <th>方向</th>
              <th>份额</th>
              <th>均价</th>
              <th>市值</th>
              <th>PnL</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    const REFRESH_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes
    const DEFAULT_TRADES_LIMIT = 10;
    const EXPANDED_TRADES_LIMIT = 50;
    let nextRefresh = Date.now() + REFRESH_INTERVAL_MS;
    let countdownTimer;
    let polyTradesExpanded = false;
    let opinionTradesExpanded = false;
    let allPolyTrades = [];
    let allOpinionTrades = [];
    let marketMatches = {}; // polymarket condition_id -> question mapping
    let opinionMarketMatches = {}; // opinion market_id -> question mapping

    const polyTable = document.querySelector('#polymarket-table tbody');
    const opinionTable = document.querySelector('#opinion-table tbody');
    const matchedTable = document.querySelector('#matched-pairs-table tbody');
    const polyTradesTable = document.querySelector('#poly-trades-table tbody');
    const opinionTradesTable = document.querySelector('#opinion-trades-table tbody');
    const polyTotal = document.getElementById('poly-total');
    const polyAddressLabel = document.getElementById('poly-address');
    const polyError = document.getElementById('poly-error');
    const opinionTotal = document.getElementById('opinion-total');
    const opinionError = document.getElementById('opinion-error');
    const matchedTotal = document.getElementById('matched-total');
    const matchedError = document.getElementById('matched-error');
    const lastUpdated = document.getElementById('last-updated');
    const countdown = document.getElementById('countdown');
    const opinionStatus = document.getElementById('opinion-status');
    async function fetchData() {
      try {
        const res = await fetch('/api/positions', { cache: 'no-store' });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        // Build market matches lookup from matched pairs data
        if (data.matchedPairs && data.matchedPairs.pairs) {
          // Also try to get from positions data for condition_id mapping
        }
        renderTables(data);
        lastUpdated.textContent = new Date(data.lastUpdated).toLocaleString();
        nextRefresh = Date.now() + REFRESH_INTERVAL_MS;
      } catch (err) {
        polyError.textContent = `Polymarket 拉取失败：${err.message}`;
        opinionError.textContent = `Opinion 拉取失败：${err.message}`;
      }
    }

    async function fetchMarketMatches() {
      try {
        const res = await fetch('/api/market_matches', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (Array.isArray(data)) {
          data.forEach(match => {
            if (match.polymarket_condition_id) {
              marketMatches[match.polymarket_condition_id] = match.question;
            }
            if (match.opinion_market_id) {
              opinionMarketMatches[match.opinion_market_id] = match.question;
            }
          });
        }
      } catch (err) {
        console.error('Failed to fetch market matches:', err);
      }
    }

    async function fetchTrades(limit = DEFAULT_TRADES_LIMIT) {
      try {
        const res = await fetch(`/api/trades?limit=${limit}`, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        allPolyTrades = data.polymarketTrades || [];
        allOpinionTrades = data.opinionTrades || [];
        renderPolyTrades();
        renderOpinionTrades();
      } catch (err) {
        console.error('Failed to fetch trades:', err);
      }
    }

    function togglePolyTrades() {
      polyTradesExpanded = !polyTradesExpanded;
      const btn = document.getElementById('poly-trades-more-btn');
      if (polyTradesExpanded) {
        btn.textContent = '收起';
        fetchTrades(EXPANDED_TRADES_LIMIT);
      } else {
        btn.textContent = '展开更多';
        fetchTrades(DEFAULT_TRADES_LIMIT);
      }
    }

    function toggleOpinionTrades() {
      opinionTradesExpanded = !opinionTradesExpanded;
      const btn = document.getElementById('opinion-trades-more-btn');
      if (opinionTradesExpanded) {
        btn.textContent = '收起';
        fetchTrades(EXPANDED_TRADES_LIMIT);
      } else {
        btn.textContent = '展开更多';
        fetchTrades(DEFAULT_TRADES_LIMIT);
      }
    }

    function formatUnixTimestamp(timestamp) {
      if (!timestamp) return '--';
      const ts = parseInt(timestamp, 10);
      if (isNaN(ts)) return '--';
      const date = new Date(ts * 1000);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function getMarketTitle(conditionId) {
      return marketMatches[conditionId] || conditionId?.slice(0, 10) + '...' || '--';
    }

    function getOpinionMarketTitle(marketId) {
      return opinionMarketMatches[marketId] || '--';
    }

    function renderPolyTrades() {
      const trades = polyTradesExpanded ? allPolyTrades : allPolyTrades.slice(0, DEFAULT_TRADES_LIMIT);
      const emptyEl = document.getElementById('poly-trades-empty');
      if (!trades || trades.length === 0) {
        polyTradesTable.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';
      polyTradesTable.innerHTML = '';
      trades.forEach(trade => {
        const tr = document.createElement('tr');
        const matchTime = formatUnixTimestamp(trade.match_time);
        const sideClass = trade.side === 'BUY' ? 'trade-side-buy' : 'trade-side-sell';
        const marketTitle = getMarketTitle(trade.market);
        const outcomeDisplay = trade.outcome || '';
        const sideDisplay = `${trade.side || '--'}${outcomeDisplay ? ' ' + outcomeDisplay : ''}`;
        tr.innerHTML = `
          <td>${matchTime}</td>
          <td title="${escapeHtml(marketTitle)}">${escapeHtml(marketTitle)}</td>
          <td class="${sideClass}">${sideDisplay}</td>
          <td>${formatNumber(trade.size)}</td>
          <td>${formatUSD(trade.price)}</td>
        `;
        polyTradesTable.appendChild(tr);
      });
    }

    function renderOpinionTrades() {
      const trades = opinionTradesExpanded ? allOpinionTrades : allOpinionTrades.slice(0, DEFAULT_TRADES_LIMIT);
      const emptyEl = document.getElementById('opinion-trades-empty');
      if (!trades || trades.length === 0) {
        opinionTradesTable.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';
      opinionTradesTable.innerHTML = '';
      trades.forEach(trade => {
        const tr = document.createElement('tr');
        const createdAt = formatUnixTimestamp(trade.createdAt);
        const sideClass = trade.side === 'BUY' ? 'trade-side-buy' : 'trade-side-sell';
        const marketTitle = getOpinionMarketTitle(trade.marketId) || trade.marketTitle || '--';
        const sideDisplay = `${trade.side || '--'}${trade.outcomeSide ? ' ' + trade.outcomeSide : ''}`;
        tr.innerHTML = `
          <td>${createdAt}</td>
          <td title="${escapeHtml(marketTitle)}">${escapeHtml(marketTitle)}</td>
          <td class="${sideClass}">${sideDisplay}</td>
          <td>${formatNumber(trade.shares)}</td>
          <td>${formatUSD(trade.price)}</td>
        `;
        opinionTradesTable.appendChild(tr);
      });
    }

    function renderTables(data) {
      renderPolymarket(data.polymarket);
      renderOpinion(data.opinion);
      renderMatchedPairs(data.matchedPairs);
    }

    function renderPolymarket(poly) {
      polyAddressLabel.textContent = poly.address ?? '未知';
      polyTotal.textContent = formatUSD(poly.totalValue);
      polyError.textContent = poly.error ? `⚠️ ${poly.error}` : '';
      renderRows(polyTable, poly.positions, ['market', 'outcome', 'size', 'avgPrice', 'currentValue', 'cashPnl'], polyFormatter);
    }

    function renderOpinion(opinion) {
      opinionStatus.textContent = opinion.error ? '未连接' : '已连接';
      opinionTotal.textContent = formatUSD(opinion.totalValue);
      opinionError.textContent = opinion.error ? `⚠️ ${opinion.error}` : '';
      renderRows(opinionTable, opinion.positions, ['marketTitle', 'side', 'shares', 'avgPrice', 'currentValue', 'unrealizedPnl'], opinionFormatter);
    }

    function renderMatchedPairs(matched) {
      matchedTotal.textContent = formatUSD(matched.totalMatchedValue || 0);
      matchedError.textContent = matched.error ? `⚠️ ${matched.error}` : '';
      renderMatchedRows(matchedTable, matched.pairs || []);
    }

    function renderMatchedRows(tbody, pairs) {
      tbody.innerHTML = '';
      if (!pairs || pairs.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'empty';
        td.textContent = '暂无跨平台配对仓位';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      pairs.forEach((pair) => {
        const tr = document.createElement('tr');

        // Market question
        const tdQuestion = document.createElement('td');
        tdQuestion.textContent = pair.question || '--';
        tdQuestion.style.maxWidth = '300px';
        tdQuestion.style.overflow = 'hidden';
        tdQuestion.style.textOverflow = 'ellipsis';
        tdQuestion.style.whiteSpace = 'nowrap';
        tdQuestion.title = pair.question;
        tr.appendChild(tdQuestion);

        // Pair type
        const tdType = document.createElement('td');
        const typeColor = pair.pairType.startsWith('Cross') ? 'var(--accent)' : 'var(--text)';
        tdType.innerHTML = `<span style="color: ${typeColor}">${pair.pairType}</span>`;
        tr.appendChild(tdType);

        // Poly shares
        const tdPolyShares = document.createElement('td');
        tdPolyShares.textContent = formatNumber(pair.polymarketPosition.size);
        tr.appendChild(tdPolyShares);

        // Opinion shares
        const tdOpinionShares = document.createElement('td');
        tdOpinionShares.textContent = formatNumber(pair.opinionPosition.size);
        tr.appendChild(tdOpinionShares);

        // Matched shares
        const tdMatched = document.createElement('td');
        tdMatched.innerHTML = `<strong>${formatNumber(pair.matchedShares)}</strong>`;
        tr.appendChild(tdMatched);

        // Settlement value
        const tdValue = document.createElement('td');
        tdValue.innerHTML = `<strong style="color: var(--gain)">${formatUSD(pair.matchedValue)}</strong>`;
        tr.appendChild(tdValue);

        tbody.appendChild(tr);
      });
    }

    function renderRows(tbody, rows, columns, formatter) {
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = columns.length;
        td.className = 'empty';
        td.textContent = '暂无满足条件的仓位';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      rows.forEach((row) => {
        const tr = document.createElement('tr');
        columns.forEach((col) => {
          const td = document.createElement('td');
          td.innerHTML = formatter(col, row[col]);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function polyFormatter(col, value) {
      switch (col) {
        case 'size':
          return formatNumber(value);
        case 'avgPrice':
          return formatUSD(value);
        case 'currentValue':
          return `<strong>${formatUSD(value)}</strong>`;
        case 'cashPnl':
          return formatPnl(value);
        default:
          return escapeHtml(value ?? '--');
      }
    }

    function opinionFormatter(col, value) {
      switch (col) {
        case 'shares':
          return formatNumber(value);
        case 'avgPrice':
          return formatUSD(value);
        case 'currentValue':
          return `<strong>${formatUSD(value)}</strong>`;
        case 'unrealizedPnl':
          return formatPnl(value);
        default:
          return escapeHtml(value ?? '--');
      }
    }

    function formatUSD(value) {
      const num = Number(value) || 0;
      return `$${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function formatNumber(value) {
      const num = Number(value) || 0;
      return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function formatPnl(value) {
      const num = Number(value) || 0;
      const cls = num >= 0 ? 'gain' : 'loss';
      return `<span class="${cls}">${formatUSD(num)}</span>`;
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function tickCountdown() {
      const diff = Math.max(0, nextRefresh - Date.now());
      const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
      const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
      const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
      countdown.textContent = `${hours}:${minutes}:${seconds}`;
    }

    countdownTimer = setInterval(() => {
      tickCountdown();
    }, 1000);

    // Initialize: fetch market matches first, then data and trades
    async function init() {
      await fetchMarketMatches();
      fetchData();
      fetchTrades();
    }
    init();
    setInterval(fetchData, REFRESH_INTERVAL_MS);
    setInterval(() => fetchTrades(polyTradesExpanded || opinionTradesExpanded ? EXPANDED_TRADES_LIMIT : DEFAULT_TRADES_LIMIT), REFRESH_INTERVAL_MS);
  </script>
</body>
</html>
