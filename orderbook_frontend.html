<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket ËÆ¢ÂçïÁ∞øÂÆûÊó∂ÁõëÊéß</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #fff;
        }

        .status {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            background: #1a1f3a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls input {
            background: #0a0e27;
            border: 1px solid #3a4f7a;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            flex: 1;
            min-width: 300px;
        }

        .controls button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #3a62a8;
        }

        .controls button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #1a1f3a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5298;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .spread-info {
            font-size: 14px;
            color: #ffd700;
        }

        .orderbook-container {
            display: flex;
            gap: 10px;
        }

        .orderbook-side {
            flex: 1;
        }

        .side-header {
            text-align: center;
            font-weight: bold;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .bids-header {
            background: rgba(34, 139, 34, 0.2);
            color: #4ade80;
        }

        .asks-header {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        .orderbook-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 4px 8px;
            position: relative;
            overflow: hidden;
            border-radius: 2px;
            margin-bottom: 1px;
            font-size: 13px;
        }

        .orderbook-row.bid {
            background: linear-gradient(to left, transparent, rgba(34, 139, 34, 0.1));
        }

        .orderbook-row.ask {
            background: linear-gradient(to right, transparent, rgba(220, 38, 38, 0.1));
        }

        .orderbook-row.flash {
            animation: flash 0.3s ease-out;
        }

        @keyframes flash {
            0% { background-color: rgba(255, 215, 0, 0.5); }
            100% { background-color: transparent; }
        }

        .depth-bar {
            position: absolute;
            top: 0;
            height: 100%;
            opacity: 0.2;
            z-index: -1;
        }

        .depth-bar.bid {
            background: #228b22;
            right: 0;
        }

        .depth-bar.ask {
            background: #dc2626;
            left: 0;
        }

        .price {
            font-weight: bold;
        }

        .price.bid {
            color: #4ade80;
        }

        .price.ask {
            color: #f87171;
        }

        .size {
            color: #a0a0a0;
        }

        .total {
            color: #707070;
            font-size: 11px;
        }

        .trades-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .trade-row {
            display: grid;
            grid-template-columns: 120px 1fr 1fr;
            padding: 6px 8px;
            border-bottom: 1px solid #2a2f4a;
            font-size: 13px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .trade-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .trade-time {
            color: #888;
        }

        .trade-price.buy {
            color: #4ade80;
            font-weight: bold;
        }

        .trade-price.sell {
            color: #f87171;
            font-weight: bold;
        }

        .trade-size {
            color: #a0a0a0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(42, 82, 152, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2a5298;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #0a0e27;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #2a5298;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #3a62a8;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .message-log {
            background: #0a0e27;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            color: #888;
            margin-top: 10px;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #1a1f3a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Polymarket ËÆ¢ÂçïÁ∞øÂÆûÊó∂ÁõëÊéß</h1>
            <div class="status">
                <div class="status-item">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Êú™ËøûÊé•</span>
                </div>
                <div class="status-item">
                    <span>Âª∂Ëøü: <strong id="latency">-</strong>ms</span>
                </div>
                <div class="status-item">
                    <span>Ê∂àÊÅØÊï∞: <strong id="msgCount">0</strong></span>
                </div>
                <div class="status-item">
                    <span>ÊúÄÂêéÊõ¥Êñ∞: <strong id="lastUpdate">-</strong></span>
                </div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="assetId" 
                   placeholder="ËæìÂÖ• Asset ID (‰æãÂ¶Ç: 13574144071637000647847673812540937418094892574120740792765602393177388985995)"
                   value="13574144071637000647847673812540937418094892574120740792765602393177388985995">
            <button id="connectBtn" onclick="connect()">ËøûÊé•</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Êñ≠ÂºÄ</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ÊúÄ‰Ω≥‰π∞‰ª∑ (Bid)</div>
                <div class="stat-value" id="bestBid" style="color: #4ade80;">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ÊúÄ‰Ω≥Âçñ‰ª∑ (Ask)</div>
                <div class="stat-value" id="bestAsk" style="color: #f87171;">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‰ª∑Â∑Æ (Spread)</div>
                <div class="stat-value" id="spread" style="color: #ffd700;">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ÊúÄÊñ∞Êàê‰∫§‰ª∑</div>
                <div class="stat-value" id="lastPrice">-</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üìñ ËÆ¢ÂçïÁ∞ø</div>
                </div>
                <div class="orderbook-container">
                    <div class="orderbook-side">
                        <div class="side-header bids-header">‰π∞Âçï (Bids)</div>
                        <div id="bidsContainer" class="scrollbar-thin" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="orderbook-side">
                        <div class="side-header asks-header">ÂçñÂçï (Asks)</div>
                        <div id="asksContainer" class="scrollbar-thin" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üíπ ÊúÄÊñ∞Êàê‰∫§</div>
                </div>
                <div id="tradesContainer" class="trades-container scrollbar-thin"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">üìù Ê∂àÊÅØÊó•Âøó</div>
            </div>
            <div id="messageLog" class="message-log scrollbar-thin"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let msgCount = 0;
        let lastMessageTime = 0;
        const maxTrades = 50;
        const maxLogEntries = 100;

        // ‰ΩøÁî® Map Êù•Â≠òÂÇ®ËÆ¢ÂçïÁ∞øÊï∞ÊçÆÔºåÊèêÈ´òÊü•ÊâæÂíåÊõ¥Êñ∞ÊïàÁéá
        let bidsMap = new Map();
        let asksMap = new Map();
        let maxDepth = 0;

        function connect() {
            const assetId = document.getElementById('assetId').value.trim();
            if (!assetId) {
                alert('ËØ∑ËæìÂÖ• Asset ID');
                return;
            }

            // ËøûÊé•Âà∞Êú¨Âú∞ WebSocket ÊúçÂä°Âô®
            const wsUrl = 'ws://localhost:8765';
            
            updateStatus('ËøûÊé•‰∏≠...', false);
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateStatus('Â∑≤ËøûÊé•', true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                // ÂèëÈÄÅËÆ¢ÈòÖÊ∂àÊÅØ
                const subscribeMsg = {
                    type: 'subscribe',
                    asset_id: assetId
                };
                ws.send(JSON.stringify(subscribeMsg));
                addLog('Â∑≤ÂèëÈÄÅËÆ¢ÈòÖËØ∑Ê±Ç: ' + assetId);
            };

            ws.onmessage = (event) => {
                const now = Date.now();
                const latency = lastMessageTime ? now - lastMessageTime : 0;
                lastMessageTime = now;
                
                document.getElementById('latency').textContent = latency;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                msgCount++;
                document.getElementById('msgCount').textContent = msgCount;

                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.error('Ëß£ÊûêÊ∂àÊÅØÂ§±Ë¥•:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket ÈîôËØØ:', error);
                updateStatus('ËøûÊé•ÈîôËØØ', false);
                addLog('ÈîôËØØ: ' + error.message, true);
            };

            ws.onclose = () => {
                updateStatus('Â∑≤Êñ≠ÂºÄ', false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                addLog('ËøûÊé•Â∑≤ÂÖ≥Èó≠');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function handleMessage(data) {
            if (Array.isArray(data)) {
                // Â§ÑÁêÜÊï∞ÁªÑÊ†ºÂºèÁöÑÊ∂àÊÅØ
                data.forEach(msg => processMessage(msg));
            } else {
                processMessage(data);
            }
        }

        function processMessage(msg) {
            if (msg.event_type === 'book') {
                // ÂÆåÊï¥ËÆ¢ÂçïÁ∞øÊõ¥Êñ∞
                updateOrderBook(msg.bids, msg.asks);
                addLog(`ËÆ¢ÂçïÁ∞øÊõ¥Êñ∞: ${msg.bids?.length || 0} ‰π∞Âçï, ${msg.asks?.length || 0} ÂçñÂçï`);
            } else if (msg.event_type === 'price_change') {
                // ‰ª∑Ê†ºÂèòÂåñ
                handlePriceChange(msg);
                addLog(`‰ª∑Ê†ºÂèòÂåñ: ${msg.price_changes?.length || 0} È°π`);
            } else if (msg.event_type === 'last_trade_price') {
                // ÊúÄÊñ∞Êàê‰∫§
                handleTrade(msg);
                addLog(`Êàê‰∫§: ${msg.price} x ${msg.size}`);
            }
        }

        function updateOrderBook(bids, asks) {
            if (!bids || !asks) return;

            // Ê∏ÖÁ©∫Âπ∂ÈáçÂª∫ Map
            bidsMap.clear();
            asksMap.clear();
            maxDepth = 0;

            let totalBid = 0;
            bids.forEach(bid => {
                const size = parseFloat(bid.size);
                totalBid += size;
                bidsMap.set(bid.price, { size, total: totalBid });
                maxDepth = Math.max(maxDepth, totalBid);
            });

            let totalAsk = 0;
            asks.forEach(ask => {
                const size = parseFloat(ask.size);
                totalAsk += size;
                asksMap.set(ask.price, { size, total: totalAsk });
                maxDepth = Math.max(maxDepth, totalAsk);
            });

            renderOrderBook();
            updateBestPrices();
        }

        function renderOrderBook() {
            const bidsContainer = document.getElementById('bidsContainer');
            const asksContainer = document.getElementById('asksContainer');

            // ‰ΩøÁî® DocumentFragment ÂáèÂ∞ë DOM Êìç‰Ωú
            const bidsFragment = document.createDocumentFragment();
            const asksFragment = document.createDocumentFragment();

            // Ê∏≤Êüì‰π∞ÂçïÔºà‰ª∑Ê†º‰ªéÈ´òÂà∞‰ΩéÔºâ
            const sortedBids = Array.from(bidsMap.entries())
                .sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]))
                .slice(0, 20);

            sortedBids.forEach(([price, data]) => {
                const row = createOrderRow(price, data.size, data.total, 'bid');
                bidsFragment.appendChild(row);
            });

            // Ê∏≤ÊüìÂçñÂçïÔºà‰ª∑Ê†º‰ªé‰ΩéÂà∞È´òÔºâ
            const sortedAsks = Array.from(asksMap.entries())
                .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))
                .slice(0, 20);

            sortedAsks.forEach(([price, data]) => {
                const row = createOrderRow(price, data.size, data.total, 'ask');
                asksFragment.appendChild(row);
            });

            // ‰∏ÄÊ¨°ÊÄßÊõ¥Êñ∞ DOM
            bidsContainer.innerHTML = '';
            asksContainer.innerHTML = '';
            bidsContainer.appendChild(bidsFragment);
            asksContainer.appendChild(asksFragment);
        }

        function createOrderRow(price, size, total, side) {
            const row = document.createElement('div');
            row.className = `orderbook-row ${side}`;
            
            const depthPercent = (total / maxDepth) * 100;
            const depthBar = document.createElement('div');
            depthBar.className = `depth-bar ${side}`;
            depthBar.style.width = `${depthPercent}%`;
            
            row.innerHTML = `
                <span class="price ${side}">${price}</span>
                <span class="size">${size.toFixed(2)}</span>
                <span class="total">${total.toFixed(2)}</span>
            `;
            row.appendChild(depthBar);
            
            return row;
        }

        function handlePriceChange(msg) {
            // Â§ÑÁêÜ‰ª∑Ê†ºÂèòÂåñ
            if (msg.price_changes) {
                msg.price_changes.forEach(change => {
                    const assetId = document.getElementById('assetId').value.trim();
                    if (change.asset_id === assetId) {
                        // Êõ¥Êñ∞ÂØπÂ∫î‰ª∑Ê†ºÁöÑÊï∞ÊçÆ
                        const price = change.price;
                        const size = parseFloat(change.size);
                        
                        if (change.side === 'BUY') {
                            if (size > 0) {
                                bidsMap.set(price, { size, total: 0 }); // total Â∞ÜÂú®ÈáçÊñ∞ËÆ°ÁÆóÊó∂Êõ¥Êñ∞
                            } else {
                                bidsMap.delete(price);
                            }
                        } else if (change.side === 'SELL') {
                            if (size > 0) {
                                asksMap.set(price, { size, total: 0 });
                            } else {
                                asksMap.delete(price);
                            }
                        }
                    }
                });
                
                // ÈáçÊñ∞ËÆ°ÁÆóÁ¥ØËÆ°Èáè
                recalculateTotals();
                renderOrderBook();
                updateBestPrices();
            }
        }

        function recalculateTotals() {
            maxDepth = 0;
            
            // ÈáçÊñ∞ËÆ°ÁÆó‰π∞ÂçïÁ¥ØËÆ°
            const sortedBids = Array.from(bidsMap.entries())
                .sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
            let totalBid = 0;
            sortedBids.forEach(([price, data]) => {
                totalBid += data.size;
                data.total = totalBid;
                maxDepth = Math.max(maxDepth, totalBid);
            });

            // ÈáçÊñ∞ËÆ°ÁÆóÂçñÂçïÁ¥ØËÆ°
            const sortedAsks = Array.from(asksMap.entries())
                .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));
            let totalAsk = 0;
            sortedAsks.forEach(([price, data]) => {
                totalAsk += data.size;
                data.total = totalAsk;
                maxDepth = Math.max(maxDepth, totalAsk);
            });
        }

        function handleTrade(msg) {
            const tradesContainer = document.getElementById('tradesContainer');
            const trade = document.createElement('div');
            trade.className = 'trade-row';
            
            const time = new Date(parseInt(msg.timestamp)).toLocaleTimeString();
            const side = msg.side === 'BUY' ? 'buy' : 'sell';
            
            trade.innerHTML = `
                <span class="trade-time">${time}</span>
                <span class="trade-price ${side}">${msg.price}</span>
                <span class="trade-size">${parseFloat(msg.size).toFixed(2)}</span>
            `;
            
            tradesContainer.insertBefore(trade, tradesContainer.firstChild);
            
            // ÈôêÂà∂ÊòæÁ§∫Êï∞Èáè
            while (tradesContainer.children.length > maxTrades) {
                tradesContainer.removeChild(tradesContainer.lastChild);
            }

            // Êõ¥Êñ∞ÊúÄÊñ∞Êàê‰∫§‰ª∑
            document.getElementById('lastPrice').textContent = msg.price;
        }

        function updateBestPrices() {
            const bestBid = Math.max(...Array.from(bidsMap.keys()).map(parseFloat));
            const bestAsk = Math.min(...Array.from(asksMap.keys()).map(parseFloat));
            
            document.getElementById('bestBid').textContent = bestBid > 0 ? bestBid.toFixed(2) : '-';
            document.getElementById('bestAsk').textContent = bestAsk < Infinity ? bestAsk.toFixed(2) : '-';
            
            if (bestBid > 0 && bestAsk < Infinity) {
                const spread = bestAsk - bestBid;
                document.getElementById('spread').textContent = spread.toFixed(4);
            } else {
                document.getElementById('spread').textContent = '-';
            }
        }

        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }

        function addLog(message, isError = false) {
            const logContainer = document.getElementById('messageLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.color = isError ? '#f87171' : '#888';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // ÈôêÂà∂Êó•ÂøóÊï∞Èáè
            while (logContainer.children.length > maxLogEntries) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂ÂÖ≥Èó≠ËøûÊé•
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
